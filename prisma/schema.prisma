// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CITIZEN
  OFFICER
  ADMIN
}

enum CaseStatus {
  CREATED
  ASSIGNED
  ACKNOWLEDGED
  EN_ROUTE
  ON_SCENE
  ACTION_TAKEN
  CLOSED
}

enum OfficerStatus {
  AVAILABLE
  ON_DUTY
  BUSY
  OFF_DUTY
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  RETRY
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id            String    @id @default(uuid())
  firebaseUid   String?   @unique
  phone         String?   @unique
  googleId      String?   @unique
  name          String
  email         String?   @unique
  avatar        String?
  age           Int?
  profileCompleted Boolean @default(false)
  role          UserRole
  isActive      Boolean   @default(true)
  
  // Password authentication (for officers)
  password           String?
  passwordResetToken String?
  passwordResetExpiry DateTime?
  mustChangePassword Boolean   @default(false)
  
  // Account status
  accountStatus  String    @default("ACTIVE") // PENDING, ACTIVE, SUSPENDED, INACTIVE
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  citizenProfile   CitizenProfile?
  officerProfile   OfficerProfile?
  adminProfile     AdminProfile?
  auditLogs        AuditLog[]
  
  @@index([firebaseUid])
  @@index([phone])
  @@index([googleId])
  @@index([email])
}

model CitizenProfile {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  address         String?
  emergencyNote   String?
  bloodGroup      String?
  medicalInfo     String?
  
  guardians       Guardian[]
  sosCases        SosCase[]
  feedbacks       Feedback[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

model Guardian {
  id              String    @id @default(uuid())
  citizenId       String
  citizen         CitizenProfile @relation(fields: [citizenId], references: [id], onDelete: Cascade)
  
  name            String
  phone           String
  relation        String
  isPrimary       Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([citizenId])
  @@index([phone])
}

model OfficerProfile {
  id              String         @id @default(uuid())
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  badgeNumber     String         @unique
  officerId       String?        @unique // Generated by admin (e.g., OF2024001)
  designation     String
  station         String         // Keep for backward compatibility
  stationId       String?        // FK to PoliceStation
  policeStation   PoliceStation? @relation(fields: [stationId], references: [id])
  status          OfficerStatus  @default(AVAILABLE)

  currentLat      Float?
  currentLng      Float?
  lastLocationUpdate DateTime?

  assignedCases   SosCase[]
  locationLogs    OfficerLocationLog[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([badgeNumber])
  @@index([status])
  @@index([stationId])
}

model AdminProfile {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  department      String
  accessLevel     Int       @default(1)

  feedbackReplies FeedbackReply[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

model PoliceStation {
  id              String    @id @default(uuid())

  // Mapbox Integration Fields
  mapboxPlaceId   String    @unique
  name            String
  address         String

  // Location Data
  latitude        Float
  longitude       Float

  // Additional Metadata
  district        String?
  state           String?
  pincode         String?
  phone           String?

  // Status
  isActive        Boolean   @default(true)

  // Relations
  officers        OfficerProfile[]
  registrationRequests OfficerRegistrationRequest[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([latitude, longitude])
  @@index([mapboxPlaceId])
  @@index([name])
  @@index([isActive])
}

model SosCase {
  id              String        @id @default(uuid())
  caseNumber      String        @unique
  
  // Citizen Info
  citizenId       String
  citizen         CitizenProfile @relation(fields: [citizenId], references: [id])
  
  // Location
  latitude        Float
  longitude       Float
  accuracy        Float?
  address         String?
  
  // Assignment
  officerId       String?
  officer         OfficerProfile? @relation(fields: [officerId], references: [id])
  assignedAt      DateTime?
  assignedBy      String?
  
  // Status
  status          CaseStatus     @default(CREATED)
  priority        Int            @default(1)
  
  // Details
  description     String?
  closureNotes    String?
  closedAt        DateTime?
  
  // Video Evidence (10-second recording)
  videoUrl        String?
  videoFileName   String?
  videoDuration   Float?       // Duration in seconds
  videoUploadedAt DateTime?
  
  // Relations
  statusLogs      CaseStatusLog[]
  evidence        Evidence[]
  notifications   Notification[]
  feedback        Feedback?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([citizenId])
  @@index([officerId])
  @@index([status])
  @@index([createdAt])
  @@index([caseNumber])
}

model CaseStatusLog {
  id              String     @id @default(uuid())
  caseId          String
  case            SosCase    @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  fromStatus      CaseStatus?
  toStatus        CaseStatus
  changedBy       String
  notes           String?
  timestamp       DateTime   @default(now())
  
  @@index([caseId])
  @@index([timestamp])
}

model Evidence {
  id              String    @id @default(uuid())
  caseId          String
  case            SosCase   @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  fileUrl         String
  fileType        String
  fileName        String
  fileSize        Int
  
  // Metadata
  capturedAt      DateTime  @default(now())
  latitude        Float?
  longitude       Float?
  uploadedBy      String
  
  // Security
  virusScanStatus String?   @default("pending")
  accessLevel     String    @default("restricted")
  
  createdAt       DateTime  @default(now())
  
  @@index([caseId])
}

model OfficerLocationLog {
  id              String         @id @default(uuid())
  officerId       String
  officer         OfficerProfile @relation(fields: [officerId], references: [id], onDelete: Cascade)
  
  latitude        Float
  longitude       Float
  accuracy        Float?
  caseId          String?
  
  timestamp       DateTime       @default(now())
  
  @@index([officerId])
  @@index([caseId])
  @@index([timestamp])
}

model Notification {
  id              String             @id @default(uuid())
  caseId          String?
  case            SosCase?           @relation(fields: [caseId], references: [id])
  
  recipient       String
  type            String
  template        String
  
  status          NotificationStatus @default(PENDING)
  message         String
  metadata        Json?
  
  sentAt          DateTime?
  failureReason   String?
  retryCount      Int                @default(0)
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  @@index([caseId])
  @@index([status])
  @@index([createdAt])
}

model OfficerRegistrationRequest {
  id              String              @id @default(uuid())

  // Personal Details
  name            String
  email           String
  phone           String
  dateOfBirth     DateTime?

  // Officer Details
  badgeNumber     String
  designation     String
  station         String              // Keep for backward compatibility
  stationId       String?             // FK to PoliceStation
  policeStation   PoliceStation?      @relation(fields: [stationId], references: [id])
  department      String
  joiningDate     DateTime?

  // Documents
  idProofUrl      String?
  photoUrl        String?

  // Status
  status          RegistrationStatus  @default(PENDING)
  rejectionReason String?

  // Admin Review
  reviewedBy      String?
  reviewedAt      DateTime?

  // Generated Credentials (after approval)
  generatedOfficerId String?         @unique

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([email])
  @@unique([phone])
  @@unique([badgeNumber])
  @@index([status])
  @@index([email])
  @@index([phone])
  @@index([stationId])
}

model AuditLog {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  action          String
  resource        String
  resourceId      String?
  
  ipAddress       String?
  userAgent       String?
  metadata        Json?
  
  timestamp       DateTime  @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

model Feedback {
  id              String         @id @default(uuid())
  caseId          String         @unique
  case            SosCase        @relation(fields: [caseId], references: [id], onDelete: Cascade)

  citizenId       String
  citizen         CitizenProfile @relation(fields: [citizenId], references: [id])

  text            String
  resolved        Boolean
  rating          Int?

  photoUrl        String?
  photoFileName   String?
  photoFileSize   Int?
  videoUrl        String?
  videoFileName   String?
  videoFileSize   Int?

  replies         FeedbackReply[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([caseId])
  @@index([citizenId])
  @@index([createdAt])
}

model FeedbackReply {
  id              String       @id @default(uuid())
  feedbackId      String
  feedback        Feedback     @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  adminId         String
  admin           AdminProfile @relation(fields: [adminId], references: [id])

  text            String

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([feedbackId])
  @@index([adminId])
}
